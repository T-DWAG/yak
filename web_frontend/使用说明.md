# 牦牛图片相似度分析系统 - 使用说明

## 系统功能

本系统用于自动分析牦牛案件图片，通过 YOLO 模型筛选和感知哈希算法，智能识别相似图片并分组。

## 案件号识别

系统会自动识别以下格式的案件号：

### 标准格式
- `DQIHWXO80125054932__20250805105326` （完整案件号+时间戳）
- `DQIHWXO80125054931` （案件号主体）

### 文件命名规范
处理后的图片命名格式：
```
案件号_g组号_序号_原文件名.扩展名
```

示例：
- `DQIHWXO80125054932__20250805105326_g1_1_IMG001.jpg`
- `DQIHWXO80125054931_g2_3_photo.png`

## 使用步骤

### 1. 启动系统

```bash
# 激活 conda 环境
conda activate yolo11

# 进入系统目录
cd code/web_frontend

# 启动服务器
python app.py
```

### 2. 访问界面

打开浏览器访问：http://localhost:5000

### 3. 上传文件

#### 方式一：拖拽上传
- 直接将 ZIP 文件拖拽到上传区域
- 支持多个文件同时拖拽

#### 方式二：点击上传
- 点击上传区域
- 选择一个或多个 ZIP 文件

#### 累加文件
- 可以分批次添加文件
- 新拖入的文件会累加到列表中
- 每个文件可单独删除

### 4. 开始分析

点击"开始分析"按钮，系统将：
1. 解压所有 ZIP 文件
2. 使用 YOLO 模型筛选 class2 图片
3. 计算图片感知哈希
4. 按相似度自动分组
5. 生成结果文件

### 5. 查看结果

处理完成后：
- **图片预览**：每组显示前3张缩略图
- **分组信息**：显示每组包含的图片数量
- **案件号标识**：文件名包含原始案件号

### 6. 下载结果

#### CSV 记录
点击"下载CSV记录"获取表格，包含：
- 组别
- 序号  
- 案件号
- 原始文件名
- 新文件名
- 来源ZIP
- ZIP内路径
- 相似度组大小

#### 完整结果
点击"下载所有结果"获取 ZIP 包，包含：
- 所有分组后的图片
- CSV 记录文件

## CSV 文件说明

### 编码格式
- UTF-8 with BOM
- Excel 可直接打开显示中文

### 字段说明
| 字段 | 说明 | 示例 |
|------|------|------|
| 组别 | 相似图片组编号 | group_1 |
| 序号 | 组内序号 | 1, 2, 3... |
| 案件号 | 提取的案件编号 | DQIHWXO80125054932__20250805105326 |
| 原始文件名 | 图片原始名称 | IMG_001.jpg |
| 新文件名 | 处理后文件名 | DQIHWXO80125054932_g1_1_IMG_001.jpg |
| 来源ZIP | 来源压缩包 | case_001.zip |
| ZIP内路径 | 在ZIP中的位置 | photos/evidence/IMG_001.jpg |
| 相似度组大小 | 该组图片总数 | 5 |

## 系统配置

### 修改配置
编辑 `app.py` 文件：

```python
# 文件大小限制（默认500MB）
app.config['MAX_CONTENT_LENGTH'] = 500 * 1024 * 1024

# 哈希相似度阈值（越小越严格）
HASH_THRESHOLD = 5

# YOLO分类阈值
CLASS2_CONFIDENCE_THRESHOLD = 0.5
```

### 模型文件
确保 YOLO 模型文件存在：
```
../../runs/classify/train26/weights/best.pt
```

## 常见问题

### Q: 上传失败
- 检查文件是否为 ZIP 格式
- 确认文件大小不超过 500MB
- 验证 ZIP 文件未损坏

### Q: 无法识别案件号
- 检查 ZIP 文件名是否包含案件号
- 案件号应在文件名中，而非路径中
- 支持格式：DQIHWXO80125054932 或带时间戳格式

### Q: 处理速度慢
- 确保使用 GPU 版本的 PyTorch
- 减少单次处理的文件数量
- 检查系统内存是否充足

### Q: CSV 乱码
- 使用 Excel 打开时选择 UTF-8 编码
- 或使用记事本打开后另存为 ANSI 编码

## 性能指标

- 单次处理：10000+ 张图片
- YOLO 分类：~100张/秒 (GPU)
- 哈希计算：~50张/秒
- 内存占用：< 2GB

## 技术支持

如遇到问题，请检查：
1. conda 环境是否正确激活
2. 所有依赖是否已安装
3. 模型文件路径是否正确
4. 端口 5000 是否被占用

---
系统版本：v1.0
更新日期：2024-08